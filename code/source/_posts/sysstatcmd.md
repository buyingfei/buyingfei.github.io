---
title: 系统监控之sysstat 命令
date: 2018-05-24 15:49:05
tags: 测试 sysstat 系统监控
categories:
- 操作系统
---

**sysstat 工具简介**
sysstat 是 Linux 系统中的常用工具包。它的主要用途是观察服务负载，比如CPU和内存的占用率、网络的使用率以及磁盘写入和读取速度等。

**sysstat 安装**
```bash
sudo yum -y install sysstat
# 安装成功后，会生成这个文件[/etc/cron.d/sysstat ] 定时生成系统统计信息
# sudo  cat /etc/cron.d/sysstat
# 默认是每10 分钟生成一次，开发环境修改为每一分钟生成一次统计信息 
# 默认生成日志文件路径[cd	/var/log/sa]
```
图示如下：
![sysstat 定时统计脚本](/source/sysstatcron.png)

**sar 命令**
在使用 Linux 系统时，常常会遇到各种各样的问题，比如系统容易死机或者运行速度突然变慢，这时我们常常猜测：是否硬盘空间不足，是否内存不足，是否 I/O 出现瓶颈，还是系统的核心参数出了问题？这时，我们应该考虑使用 sar 工具对系统做一个全面了解，分析系统的负载状况。

**输出进程队列长度和平均负载状态统计信息**
```bash
#输出进程队列长度和平均负载状态统计信息
 [root@172.16.0.56:/var/log/sa]$ sar -q
 Linux 2.6.32-431.el6.x86_64 (node56) 	05/23/2018 	_x86_64_	(2 CPU)
 
 12:00:01 AM   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15
 12:10:01 AM        26       339      0.19      0.88      1.11
 12:20:01 AM        27       333      0.57      1.02      1.10
 12:30:01 AM        30       345      0.81      0.87      0.98
 12:40:01 AM        26       340      0.07      0.44      0.75
 12:50:01 AM        28       331      0.05      0.21      0.49
 01:00:01 AM        32       359      0.12      0.13      0.32
 01:10:01 AM        25       344      0.06      0.08      0.18

```
输出项说明：


| Tables   |      Are      |
|----------|:-------------:|
| runq-sz  | 等待执行的任务队列长度，越长越阻塞|
| plist-sz | 进程列表中进程（processes）和线程（threads）的数量|
| ldavg-1  | 最后1分钟的系统平均负载（System load average）|
| ldavg-5  | 过去5分钟的系统平均负载|
| ldavg-15 | 过去15分钟的系统平均负载|

* 重点注意ldavg，代表 cpu 任务数，繁重程度,超过cpu 个数，为超负载运行 （注意观察负载变化是否剧烈）




**输出CPU使用情况的统计信息**
```bash
[root@172.16.0.56:/var/log/sa]$ sar -u
Linux 2.6.32-431.el6.x86_64 (node56) 	05/23/2018 	_x86_64_	(2 CPU)

12:00:01 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
12:10:01 AM     all      1.66      0.00      0.89      0.08      0.01     97.36
12:20:01 AM     all      1.56      0.00      0.81      0.07      0.01     97.55
12:30:01 AM     all      1.58      0.00      0.84      0.35      0.01     97.21
12:40:01 AM     all      1.57      0.00      0.82      0.06      0.01     97.54
12:50:01 AM     all      1.57      0.00      0.82      0.05      0.01     97.54
01:00:01 AM     all      1.56      0.00      0.82      0.05      0.01     97.55
01:10:01 AM     all      1.64      0.00      0.86      0.14      0.01     97.35

```
输出项说明：


| cpu   |      all 表示统计信息为所有 CPU 的平均值。      |
|----------|:-------------:|
|%user|	显示在用户级别(application)运行使用 CPU 总时间的百分比。|
|%nice	|显示在用户级别，用于nice操作，所占用 CPU 总时间的百分比。|
|%system|	在核心级别(kernel)运行所使用 CPU 总时间的百分比。|
|%iowait	|cpu 等待io占用 CPU 总时间的百分比。（值越高，等待磁盘读写压力越大，瓶颈在磁盘）|
|%steal	|管理进程等待cpu 占用 CPU 总时间的百分比。（值越高，cpu 繁重程度越高）|
|%idle	|显示 CPU 空闲时间占用 CPU 总时间的百分比。|

* 若 %iowait 的值过高，表示硬盘存在I/O瓶颈
* 若 %idle 的值高但系统响应慢时，有可能是 CPU 等待分配内存，此时应加大内存容量
* 若 %idle 的值持续低于 10，则系统的 CPU 处理能力相对较低，表明系统中最需要解决的资源是 CPU。


**输出内存和交换空间的统计信息**
```bash
[root@172.16.0.56:/var/log/sa]$ sar -r
Linux 2.6.32-431.el6.x86_64 (node56) 	05/23/2018 	_x86_64_	(2 CPU)

12:00:01 AM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit
12:10:01 AM    560300   3362440     85.72    636624   1060076   3352040     27.23
12:20:01 AM    537124   3385616     86.31    636836   1079920   3378996     27.45
12:30:01 AM    513536   3409204     86.91    637044   1096120   3410272     27.70
12:40:01 AM    511468   3411272     86.96    637204   1103256   3357232     27.27
12:50:01 AM    488416   3434324     87.55    637340   1124880   3389172     27.53
01:00:01 AM    457144   3465596     88.35    637556   1134900   3407764     27.68

```
输出项说明：

| cpu   |      all 表示统计信息为所有 CPU 的平均值。      |
|----------|:-------------:|
|kbmemfree |	可用的空闲内存数量，单位为 KB |
|kbmemused	|已使用的内存数量（不包含内核使用的内存），单位为 KB|
|%memused	|已使用内存的百分数|
|kbbuffers|	磁盘块缓存的内存数量，单位为 KB|
|kbcached|	磁盘文件缓存的内存数量，单位为 KB|
|kbcached|	程序要执行下去，系统评估还需要多少缓存的内存数量，单位为 KB|

* 如果 %memused +  %commit > 100% ,内存很危险

**物理内存放硬盘 情况**
```bash
[root@172.16.0.56:/var/log/sa]$ sar -B
Linux 2.6.32-431.el6.x86_64 (node56) 	05/23/2018 	_x86_64_	(2 CPU)

12:00:01 AM  pgpgin/s pgpgout/s   fault/s  majflt/s  pgfree/s pgscank/s pgscand/s pgsteal/s    %vmeff
12:10:01 AM      0.29    138.03   5137.86      0.01   2500.29      0.00      0.00      0.00      0.00
12:20:01 AM      0.45    136.06   4935.45      0.01   2409.97      0.00      0.11      0.11    100.00
12:30:01 AM      0.13    135.86   5002.52      0.01   2419.22      0.00      0.05      0.05    100.00
12:40:01 AM      0.09    135.66   5012.26      0.01   2436.21      0.00      0.11      0.11    100.00
12:50:01 AM      0.00    135.86   4938.99      0.00   2416.47      0.00      0.11      0.11    100.00
01:00:01 AM      0.00    136.01   5057.40      0.00   2445.28      0.00      0.11      0.11    100.00
01:10:01 AM      0.49    145.58   5024.75      0.01   2445.67      0.00      0.00      0.00      0.00
01:20:02 AM      0.00    137.24   4969.16      0.00   2430.44      0.00      0.16      0.16     98.96
01:30:01 AM      0.00    136.91   4989.06      0.00   2403.75      0.00      0.11  
```
输出项说明：

| table   |      col      |
|----------|:-------------:|
|pgpgin/s	|每秒钟从磁盘读入的系统页面的 KB 总数|
|pgpgout/s	|每秒钟向磁盘写出的系统页面的 KB 总数|
|fault/s	|系统每秒产生的页面失效(major + minor)数量|
|majflt/s	|系统每秒产生的页面失效(major)数量|



**显示I/O和传送速率的统计信息**
```bash
[root@172.16.0.56:/var/log/sa]$ sar -b
Linux 2.6.32-431.el6.x86_64 (node56) 	05/23/2018 	_x86_64_	(2 CPU)

12:00:01 AM       tps      rtps      wtps   bread/s   bwrtn/s
12:10:01 AM      5.62      0.04      5.59      0.59    276.05
12:20:01 AM      5.45      0.04      5.41      0.91    272.12
12:30:01 AM      5.48      0.02      5.46      0.25    271.73
12:40:01 AM      5.44      0.02      5.42      0.19    271.31
12:50:01 AM      5.35      0.00      5.35      0.00    271.72
01:00:01 AM      5.44      0.00      5.44      0.00    272.02
01:10:01 AM      5.95      0.08      5.88      0.99    291.15

```
输出项说明：

| table   |      col      |
|----------|:-------------:|
|tps	|每秒钟 物理设备请求次数|
|rtps	|每秒从物理设备读入请求次数|
|wtps	|每秒向物理设备写入请求次|
|bread/s	|每秒从物理设备读入请求次数，单位为 块/s|
|bwrtn/s	|每秒向物理设备写入请求次，单位为 块/s|